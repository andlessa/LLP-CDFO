# CMS-EXO-19-010 - Disappearing Tracks Analysis

This folder contains scripts to parse MG5 outputs generated by runScanMG5_hepmc.py into .ma5 input files, and modified PADForSFS versions of the analysis files to run MadAnalysis5 in recast mode for the CDFO model

## Parsing MG5 output

The bash script generate_MA5_inputs.sh can be run to create the .ma5 files needed for a MA5 scripted run. The current version of the script generates one input file per generated point to facilitate parallelization of the MA5 jobs later. The usage syntax is as follows:
```
bash generate_MA5_inputs.sh procdir_path output_path [recasting_Card_path MA5_output_path]
```
with
- **procdir\_path**: Path to the proc directory generated by runScanMG5_hepmc.py.
- **output\_path**: Path to the output directory to contain the .ma5 files.
- **recasting\_Card\_path**: Path to the modified recasting_card.dat file specifying to run only the cms_exo_19_010 analysis. Default path is `../MA5_input/recasting_card.dat`
- **MA5_output_path**: Path to the directory which will hold the results from the MadAnalysis5 jobs run from the generated `.ma5` inputs. Defaults to `~/MA5_outputs/`

> [!CAUTION]
> Points are indexed by (%format msb)\_(%format mn1), so double-check the output names in runScanMG5\_hepmc.py beforehand to avoid overlaps. 

## Preparing a MA5 run

This analysis uses the recasting mode of Madanalysis5 with modified source files for the PADForSFS analyzer. Check if PADForSFS has been properly installed running
```bash
cd MA5_path
./bin/ma5 -R
```
and checking if the corresponding printed line shows "\[OK\]" status after compiling (if needed):

```bash
MA5:      - PADForSFS                [OK]
```

The PADForSFS source files are located by default in `(MA5_path)/tools/PADForSFS/Build/SampleAnalyzer/User/Analyzer`. Replace the `cms_exo_19_010.[cpp/h/info]` files there with the corresponding ones in the `MA5_input/` folder in this directory (backup the original files beforehand if needed, but they are available in the [PAD](https://madanalysis.irmp.ucl.ac.be/wiki/PublicAnalysisDatabase)).

To run a Madanalysis5 job, use:
```bash
(MA5_path)/bin/ma5 -R -s input.ma5
```
with `input.ma5` being one of the files generated in the previous section. The `-R` flag initializes MA5 in recast mode, and `-s` defines a scripted run taking the .ma5 input, running the commands, and exiting.


## Parsing the MA5 run results

Each MA5 job generated an output directory with the following substructure (only showing the relevant folders):
- Job Output Directory
  - Input: Contains the commands ran and a `.list` file with the path to the imported dataset (hepmc file in this case)
  - Output: Contains the results of the analysis job
    - SAF: Contains `.saf` outputs generated by the analysis
      - `CLs_output_summary.dat`: File containing the exclusion limits for the analysis
      - DATASET_NAME: Folder containing results for the imported dataset, with name built in the .ma5 file from the hepmc filename
        - ANALYSIS_NAME: Folder containing results for the analysis run, in this case `cms_exo_19_010`
          - Cutflows: Folder containing the generated cutflows, in `.saf` format.

To parse all of the results generated, run the script `parse_ma5_output.py` as:
```bash
[python] parse_ma5_output MA5_output_path results_output_path
```
with
- **MA5_output_path**: Path to the directory containing the MA5 Job Output folders, specified in the `submit` line in the .ma5 input (provided via `generate_ma5_input.sh`);
- **results_output_path**: Path to the directory in which to write the `.pcl` files with the parsed pandas.DataFrame results.
